<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Watch Party with Video Call</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .room-info {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 0;
            height: calc(100vh - 160px);
        }

        .video-call-section {
            background: #1a1a2e;
            padding: 20px;
            overflow-y: auto;
        }

        .video-call-header {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .call-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .call-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .call-btn.active {
            background: #4CAF50;
            color: white;
        }

        .call-btn.inactive {
            background: #f44336;
            color: white;
        }

        .call-btn:hover {
            opacity: 0.8;
        }

        .video-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .video-section {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-controls {
            display: flex;
            gap: 10px;
        }

        #videoUrlInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border 0.3s;
        }

        #videoUrlInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #loadVideoBtn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        #loadVideoBtn:hover {
            transform: translateY(-2px);
        }

        #player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-section {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header h2 {
            font-size: 20px;
            color: #333;
        }

        .users-online {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .user-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-text {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 14px;
            word-wrap: break-word;
        }

        .message-system {
            text-align: center;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #sendBtn {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        #sendBtn:hover {
            background: #5568d3;
        }

        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .modal-content button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .modal-content button:hover {
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }

            .video-call-section {
                max-height: 300px;
            }

            .video-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .chat-section {
                border-left: none;
                border-top: 1px solid #e0e0e0;
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <h2>Join Watch Party ðŸŽ‰</h2>
            <input type="text" id="usernameInput" placeholder="Enter your name">
            <input type="text" id="roomIdInput" placeholder="Enter room ID (or leave blank to create)">
            <button id="joinBtn">Join Room</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="container">
            <div class="header">
                <h1>ðŸŽ¬ YouTube Watch Party</h1>
                <div class="room-info">Room: <span id="roomIdDisplay"></span></div>
            </div>
            
            <div class="main-content">
                <div class="video-call-section">
                    <div class="video-call-header">
                        <span>ðŸ“¹ Video Call</span>
                    </div>
                    <div class="call-controls">
                        <button id="toggleVideoBtn" class="call-btn inactive">ðŸ“· Video Off</button>
                        <button id="toggleAudioBtn" class="call-btn inactive">ðŸŽ¤ Muted</button>
                    </div>
                    <div class="video-grid" id="videoGrid">
                        <div class="video-container">
                            <video id="localVideo" autoplay muted playsinline></video>
                            <div class="video-label">You</div>
                        </div>
                    </div>
                </div>

                <div class="video-section">
                    <div class="video-controls">
                        <input type="text" id="videoUrlInput" placeholder="Paste YouTube URL here...">
                        <button id="loadVideoBtn">Load Video</button>
                    </div>
                    <div id="player"></div>
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <h2>Chat</h2>
                        <div class="users-online" id="usersOnline"></div>
                    </div>
                    <div id="messages"></div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message...">
                        <button id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXGPCCu9wLefW-Bn3kQ63rz9niHaVUogE",
            authDomain: "watch-party-f4623.firebaseapp.com",
            databaseURL: "https://watch-party-f4623-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "watch-party-f4623",
            storageBucket: "watch-party-f4623.firebasestorage.app",
            messagingSenderId: "432928189519",
            appId: "1:432928189519:web:0b4153ed3b236f7004ce3a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let player;
        let roomId;
        let username;
        let userId;
        let isUpdating = false;

        // WebRTC Variables
        let localStream = null;
        let peerConnections = {};
        let videoEnabled = false;
        let audioEnabled = false;

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // YouTube Player Setup
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onReady': onPlayerReady
                }
            });
        };

        function onPlayerReady(event) {
            syncWithRoom();
        }

        function onPlayerStateChange(event) {
            if (isUpdating) return;

            const state = event.data;
            const videoData = {
                state: state,
                time: player.getCurrentTime(),
                videoId: getVideoId(),
                timestamp: Date.now()
            };

            db.ref(`rooms/${roomId}/video`).set(videoData);
        }

        function getVideoId() {
            const url = player.getVideoUrl();
            const match = url.match(/[?&]v=([^&]+)/);
            return match ? match[1] : null;
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // WebRTC Functions
        async function initializeMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                localStream.getVideoTracks()[0].enabled = false;
                localStream.getAudioTracks()[0].enabled = false;

                document.getElementById('localVideo').srcObject = localStream;

                // Listen for new peers
                db.ref(`rooms/${roomId}/peers`).on('child_added', (snapshot) => {
                    const peerId = snapshot.key;
                    if (peerId !== userId) {
                        createPeerConnection(peerId);
                    }
                });

                db.ref(`rooms/${roomId}/peers`).on('child_removed', (snapshot) => {
                    const peerId = snapshot.key;
                    removePeerConnection(peerId);
                });

                // Listen for offers
                db.ref(`rooms/${roomId}/offers/${userId}`).on('child_added', async (snapshot) => {
                    const data = snapshot.val();
                    const peerId = data.from;
                    
                    if (!peerConnections[peerId]) {
                        await createPeerConnection(peerId);
                    }
                    
                    await peerConnections[peerId].setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnections[peerId].createAnswer();
                    await peerConnections[peerId].setLocalDescription(answer);
                    
                    await db.ref(`rooms/${roomId}/answers/${peerId}`).push({
                        from: userId,
                        answer: answer
                    });
                    
                    snapshot.ref.remove();
                });

                // Listen for answers
                db.ref(`rooms/${roomId}/answers/${userId}`).on('child_added', async (snapshot) => {
                    const data = snapshot.val();
                    const peerId = data.from;
                    
                    if (peerConnections[peerId]) {
                        await peerConnections[peerId].setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                    
                    snapshot.ref.remove();
                });

                // Listen for ICE candidates
                db.ref(`rooms/${roomId}/ice/${userId}`).on('child_added', async (snapshot) => {
                    const data = snapshot.val();
                    const peerId = data.from;
                    
                    if (peerConnections[peerId]) {
                        await peerConnections[peerId].addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                    
                    snapshot.ref.remove();
                });

                // Register this peer
                await db.ref(`rooms/${roomId}/peers/${userId}`).set({
                    name: username,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                db.ref(`rooms/${roomId}/peers/${userId}`).onDisconnect().remove();

            } catch (error) {
                console.error('Error accessing media devices:', error);
                alert('Could not access camera/microphone. Video call features will be limited.');
            }
        }

        async function createPeerConnection(peerId) {
            const peerConnection = new RTCPeerConnection(configuration);
            peerConnections[peerId] = peerConnection;

            // Add local stream
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // Handle incoming stream
            peerConnection.ontrack = (event) => {
                addRemoteVideo(peerId, event.streams[0]);
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`rooms/${roomId}/ice/${peerId}`).push({
                        from: userId,
                        candidate: event.candidate.toJSON()
                    });
                }
            };

            // Create and send offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            await db.ref(`rooms/${roomId}/offers/${peerId}`).push({
                from: userId,
                offer: offer
            });

            return peerConnection;
        }

        function addRemoteVideo(peerId, stream) {
            let videoContainer = document.getElementById(`video-${peerId}`);
            
            if (!videoContainer) {
                videoContainer = document.createElement('div');
                videoContainer.id = `video-${peerId}`;
                videoContainer.className = 'video-container';
                
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsinline = true;
                video.srcObject = stream;
                
                const label = document.createElement('div');
                label.className = 'video-label';
                label.textContent = 'Peer ' + peerId.substring(0, 6);
                
                videoContainer.appendChild(video);
                videoContainer.appendChild(label);
                document.getElementById('videoGrid').appendChild(videoContainer);
            }
        }

        function removePeerConnection(peerId) {
            if (peerConnections[peerId]) {
                peerConnections[peerId].close();
                delete peerConnections[peerId];
            }
            
            const videoElement = document.getElementById(`video-${peerId}`);
            if (videoElement) {
                videoElement.remove();
            }
        }

        function toggleVideo() {
            if (localStream) {
                videoEnabled = !videoEnabled;
                localStream.getVideoTracks()[0].enabled = videoEnabled;
                
                const btn = document.getElementById('toggleVideoBtn');
                if (videoEnabled) {
                    btn.textContent = 'ðŸ“· Video On';
                    btn.className = 'call-btn active';
                } else {
                    btn.textContent = 'ðŸ“· Video Off';
                    btn.className = 'call-btn inactive';
                }
            }
        }

        function toggleAudio() {
            if (localStream) {
                audioEnabled = !audioEnabled;
                localStream.getAudioTracks()[0].enabled = audioEnabled;
                
                const btn = document.getElementById('toggleAudioBtn');
                if (audioEnabled) {
                    btn.textContent = 'ðŸŽ¤ Unmuted';
                    btn.className = 'call-btn active';
                } else {
                    btn.textContent = 'ðŸŽ¤ Muted';
                    btn.className = 'call-btn inactive';
                }
            }
        }

        function joinRoom() {
            const userRef = db.ref(`rooms/${roomId}/users/${userId}`);
            userRef.set({
                name: username,
                joined: firebase.database.ServerValue.TIMESTAMP
            });

            userRef.onDisconnect().remove();

            // Listen for users
            db.ref(`rooms/${roomId}/users`).on('value', (snapshot) => {
                const users = snapshot.val() || {};
                updateUsersList(users);
            });

            // Listen for video changes
            db.ref(`rooms/${roomId}/video`).on('value', (snapshot) => {
                const videoData = snapshot.val();
                if (videoData) {
                    updateVideo(videoData);
                }
            });

            // Listen for messages
            db.ref(`rooms/${roomId}/messages`).on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                displayMessages(messages);
            });

            sendSystemMessage(`${username} joined the room`);
            
            // Initialize video call
            initializeMedia();
        }

        function updateUsersList(users) {
            const container = document.getElementById('usersOnline');
            container.innerHTML = '';
            Object.values(users).forEach(user => {
                const badge = document.createElement('div');
                badge.className = 'user-badge';
                badge.textContent = user.name;
                container.appendChild(badge);
            });
        }

        function updateVideo(videoData) {
            if (!player || !player.loadVideoById) return;

            isUpdating = true;

            const currentVideoId = getVideoId();
            if (videoData.videoId && videoData.videoId !== currentVideoId) {
                player.loadVideoById(videoData.videoId, videoData.time);
            }

            const timeDiff = Math.abs(player.getCurrentTime() - videoData.time);
            if (timeDiff > 2) {
                player.seekTo(videoData.time, true);
            }

            if (videoData.state === YT.PlayerState.PLAYING && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                player.playVideo();
            } else if (videoData.state === YT.PlayerState.PAUSED && player.getPlayerState() !== YT.PlayerState.PAUSED) {
                player.pauseVideo();
            }

            setTimeout(() => { isUpdating = false; }, 1000);
        }

        function syncWithRoom() {
            db.ref(`rooms/${roomId}/video`).once('value', (snapshot) => {
                const videoData = snapshot.val();
                if (videoData) {
                    updateVideo(videoData);
                }
            });
        }

        function extractVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const messageRef = db.ref(`rooms/${roomId}/messages`).push();
                messageRef.set({
                    user: username,
                    userId: userId,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            }
        }

        function sendSystemMessage(text) {
            const messageRef = db.ref(`rooms/${roomId}/messages`).push();
            messageRef.set({
                system: true,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            Object.values(messages).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)).forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                
                if (msg.system) {
                    msgDiv.innerHTML = `<div class="message-system">${msg.text}</div>`;
                } else {
                    msgDiv.innerHTML = `
                        <div class="message-user">${msg.user}</div>
                        <div class="message-text">${msg.text}</div>
                    `;
                }
                
                container.appendChild(msgDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('joinBtn').addEventListener('click', () => {
                username = document.getElementById('usernameInput').value.trim();
                let inputRoomId = document.getElementById('roomIdInput').value.trim();

                if (!username) {
                    alert('Please enter your name');
                    return;
                }

                roomId = inputRoomId || generateRoomId();
                userId = Date.now().toString();

                document.getElementById('setupModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('roomIdDisplay').textContent = roomId;

                joinRoom();
            });

            document.getElementById('loadVideoBtn').addEventListener('click', () => {
                const url = document.getElementById('videoUrlInput').value;
                const videoId = extractVideoId(url);
                
                if (videoId) {
                    player.loadVideoById(videoId);
                    sendSystemMessage(`${username} loaded a new video`);
                } else {
                    alert('Invalid YouTube URL');
                }
            });

            document.getElementById('toggleVideoBtn').addEventListener('click', toggleVideo);
            document.getElementById('toggleAudioBtn').addEventListener('click', toggleAudio);

            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            setupEventListeners();
        }
    </script>
</body>
</html>