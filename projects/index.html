<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Source Project Showcase | Codely.fun</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4338ca', // Deep Indigo (700)
                        'primary-light': '#6366f1', // Lighter Indigo (500)
                    }
                }
            },
            darkMode: 'class', 
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* 3D Tilt Effect and Shadow Lift for Project Cards */
        .project-card {
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.15); /* Deeper initial shadow */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s;
            border-left: 5px solid #a5b4fc; /* Light indigo stripe */
        }
        .project-card:hover {
            transform: translateY(-10px) rotateZ(0.5deg); /* More dramatic lift and tilt */
            box-shadow: 0 20px 40px -8px rgba(67, 56, 202, 0.45); /* Intense, colorful shadow */
        }
        .dark .project-card {
             border-left-color: #4f46e5; /* Darker stripe in dark mode */
             box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.2);
        }
        .dark .project-card:hover {
             box-shadow: 0 20px 40px -8px rgba(79, 70, 229, 0.7);
        }

        /* Subtle background gradient for depth */
        body {
            background: linear-gradient(to bottom right, #f9fafb 0%, #f3f4f6 100%);
        }
        .dark body {
            background: linear-gradient(to bottom right, #0f172a 0%, #111827 100%);
        }

        /* Gradient for Hero Text */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #4338ca 0%, #6366f1 100%);
        }

        /* Gradient Button Style */
        .btn-gradient {
            background-image: linear-gradient(to right, #4338ca 0%, #6366f1 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(67, 56, 202, 0.4);
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(67, 56, 202, 0.6);
        }
        .dark .btn-gradient {
            background-image: linear-gradient(to right, #6366f1 0%, #818cf8 100%);
            box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.6);
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
        
        // Use setLogLevel('debug') for detailed debugging in the console
        setLogLevel('debug');

        // Define Firebase Config - IMPORTANT: Replace with your actual config or use global variables
        // Since you did not provide the global variables, I am keeping the hardcoded one from your file.
        const firebaseConfig = {
            apiKey: "AIzaSyDiS42BJ1Ppc1z9UNrdyTKWtb8qmkKuQ_Y",
            authDomain: "harshitproto.firebaseapp.com",
            projectId: "harshitproto",
            storageBucket: "harshitproto.firebasestorage.app",
            messagingSenderId: "805078252087",
            appId: "1:805078252087:web:1ca3704d0e672906445db2",
            measurementId: "G-W4LY7TPYZH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let allProjects = [];

        // Attach global functions to window object
        window.openDetailsModal = openDetailsModal;
        
        // --- UTILITY FUNCTIONS ---

        async function getDownloadLink(pathOrUrl) {
            if (pathOrUrl && pathOrUrl.startsWith('gs://')) {
                try {
                    const fileRef = storageRef(storage, pathOrUrl);
                    return await getDownloadURL(fileRef);
                } catch (error) {
                    console.warn("Could not fetch download URL:", error.code);
                    return '#'; 
                }
            }
            return pathOrUrl || '#';
        }

        // --- RENDERING FUNCTIONS ---

        function createProjectCardHTML(project) {
            // FIX: Use the specific fields requested by the user for card display
            const thumbnail_url = project.thumbnail_url || 'https://via.placeholder.com/600x400.png?text=Thumbnail+Missing'; // Using thumbnail_url
            const short_description = project.short_description || 'No description provided.'; // Using short_description
            const github_url = project.github_url || '#'; // Using github_url
            
            // FIX: Ensure tags is an array before using slice/map
            const tags = Array.isArray(project.tags) ? project.tags : [];

            return `
                <div class="project-card bg-white dark:bg-gray-800 rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-700 flex flex-col transition duration-400" data-id="${project.id}">
                    
                    <div class="relative">
                        <img src="${thumbnail_url}" alt="${project.title} thumbnail" 
                             class="w-full h-48 object-cover cursor-pointer" onerror="this.onerror=null; this.src='https://via.placeholder.com/600x400.png?text=Image+Load+Failed';" onclick="openDetailsModal('${project.id}')">
                        <div class="absolute inset-x-0 bottom-0 h-1/4 bg-gradient-to-t from-gray-900/10 dark:from-gray-900/20 to-transparent"></div>
                    </div>

                    <div class="p-6 flex flex-col flex-grow">
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${tags.slice(0, 3).map(tag => 
                                `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-primary-light/10 text-primary dark:bg-indigo-900/50 dark:text-indigo-300 shadow-sm"><i class="fas fa-microchip mr-1"></i>${tag}</span>`
                            ).join('')}
                            ${tags.length === 0 ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-500">No Tags</span>` : ''}
                        </div>

                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">${project.title}</h3>
                        
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-3 flex-grow">${short_description}</p>
                        
                        <hr class="border-gray-100 dark:border-gray-700 mb-4 mt-auto">

                        <div class="space-y-3">
                            <button onclick="openDetailsModal('${project.id}')"
                                class="w-full px-4 py-2 text-base font-semibold rounded-xl text-white btn-gradient">
                                <i class="fas fa-search mr-2"></i> View Details
                            </button>
                            
                            <a href="${github_url}" target="_blank" rel="noopener noreferrer" 
                               class="flex items-center justify-center w-full px-4 py-2 text-base font-semibold rounded-xl text-gray-700 dark:text-gray-300 border-2 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <i class="fab fa-github mr-2"></i> View Code
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProjects(projectsToRender) {
            const container = document.getElementById('projects-container');
            container.innerHTML = ''; 

            if (projectsToRender.length === 0) {
                 container.innerHTML = `<div class="text-center py-20 text-gray-500 dark:text-gray-400"><p class="text-xl font-medium">No projects found matching your criteria. ðŸ˜¥</p></div>`;
                 return;
            }

            // Fallback category to display all projects together
            const defaultCategory = 'All Projects'; 

            const groupedProjects = projectsToRender.reduce((acc, project) => {
                const category = project.category || defaultCategory;
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(project);
                return acc;
            }, {});

            for (const [category, projectList] of Object.entries(groupedProjects)) {
                const section = document.createElement('section');
                section.className = 'mb-16';
                
                section.innerHTML = `
                    <div class="flex items-center mb-8">
                        <h2 class="text-3xl md:text-4xl font-black text-gray-900 dark:text-white">
                            <i class="fas fa-code mr-3 ${category === defaultCategory ? 'text-gray-500' : 'text-primary-light'}"></i>${category}
                        </h2>
                        <div class="flex-grow h-1 ml-4 rounded-full bg-primary-light/50 dark:bg-primary/50"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10">
                        ${projectList.map(createProjectCardHTML).join('')}
                    </div>
                `;
                container.appendChild(section);
            }
        }
        
        // --- MODAL/DETAILS LOGIC ---
        
        const modal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalDialog = modal.querySelector('div:first-child');
        
        document.getElementById('close-modal').onclick = () => {
            modal.classList.add('opacity-0');
            modalDialog.classList.remove('scale-100');
            modalDialog.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
            document.body.classList.remove('overflow-hidden');
        };

        modal.onclick = (e) => {
            if (e.target === modal) {
                 document.getElementById('close-modal').click();
            }
        };

        async function openDetailsModal(projectId) {
            const project = allProjects.find(p => p.id === projectId);
            if (!project) return;
            
            // FIX: Use the specific fields requested by the user for modal display
            const thumbnail_url = project.thumbnail_url || 'https://via.placeholder.com/800x600.png?text=Main+Image'; // Using thumbnail_url
            const full_description = project.full_description || 'No detailed description provided.'; // Using full_description
            const github_url = project.github_url || '#'; // Using github_url
            const category = project.category || 'General';
            
            // FIX: Ensure tags is an array
            const tags = Array.isArray(project.tags) ? project.tags : [];

            modalTitle.textContent = project.title;
            modalContent.innerHTML = '<p class="text-center py-5 dark:text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Fetching details...</p>';
            
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalDialog.classList.remove('scale-95');
                modalDialog.classList.add('scale-100');
            }, 10);

            // Fetch download link from storage path or use direct URL
            const downloadLink = await getDownloadLink(project.download_url); 
            
            modalContent.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-1/2 flex flex-col items-center">
                        <img id="main-screenshot" src="${thumbnail_url}" alt="${project.title} main image" 
                             class="w-full h-auto rounded-xl shadow-2xl shadow-indigo-500/20 mb-4 object-cover max-h-96"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/800x600.png?text=Image+Load+Failed';">
                        <div class="flex gap-3 overflow-x-auto pb-2 justify-center w-full">
                            ${(project.screenshots || []).map(url => 
                                `<img src="${url}" class="w-20 h-20 object-cover rounded-md border-2 border-transparent hover:border-primary cursor-pointer transition" alt="Screenshot" onclick="document.getElementById('main-screenshot').src='${url}'">`
                            ).join('')}
                        </div>
                    </div>

                    <div class="lg:w-1/2 space-y-6">
                        <div class="flex flex-wrap justify-between items-center text-sm">
                            <span class="font-semibold px-3 py-1 rounded-full bg-primary-light/20 text-primary-light dark:bg-indigo-900/50 dark:text-indigo-300">
                                <i class="fas fa-tag mr-1"></i> Category: ${category}
                            </span>
                            <span class="text-gray-500 dark:text-gray-400 mt-2 lg:mt-0">
                                <i class="fas fa-calendar-alt mr-1"></i> Created: ${new Date(project.created_at || new Date()).toLocaleDateString()}
                            </span>
                        </div>

                        <p class="text-gray-700 dark:text-gray-300 text-base leading-relaxed whitespace-pre-wrap">${full_description}</p>
                        
                        <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                            ${tags.map(tag => 
                                `<span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300"><i class="fas fa-wrench mr-1"></i>${tag}</span>`
                            ).join('')}
                        </div>

                        <div class="pt-4 space-y-4">
                            <a href="${downloadLink}" target="_blank" rel="noopener noreferrer" 
                               class="flex items-center justify-center w-full text-center px-6 py-3 text-lg font-bold rounded-xl text-white btn-gradient">
                                <i class="fas fa-download fa-fw mr-3"></i> Download Project
                            </a>
                            <a href="${github_url}" target="_blank" rel="noopener noreferrer" 
                               class="flex items-center justify-center w-full text-center px-6 py-3 text-lg font-bold rounded-xl text-gray-800 dark:text-gray-300 border-2 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                <i class="fab fa-github fa-fw mr-3"></i> View Source Code
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DATA FETCHING AND MAIN EXECUTION ---

        async function fetchAndRenderAllProjects() {
            try {
                // The collection path is 'projects'
                const projectsCol = collection(db, 'projects');
                const projectSnapshot = await getDocs(projectsCol);
                
                allProjects = projectSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    // Safely handle timestamp conversion (Fixes previous error)
                    created_at: doc.data().created_at && typeof doc.data().created_at.toDate === 'function' 
                                ? doc.data().created_at.toDate() 
                                : new Date(), 
                    ...doc.data() 
                }));

                document.getElementById('loading-spinner').style.display = 'none';
                renderProjects(allProjects);

            } catch (error) {
                console.error("Error fetching projects:", error);
                document.getElementById('projects-container').innerHTML = `<div class="text-center py-20 text-red-500 dark:text-red-400"><p class="text-xl font-medium">Failed to load projects. Check your console for details (F12).</p></div>`;
            }
        }

        // --- SEARCH LOGIC ---
        
        const searchInput = document.getElementById('search-input');
        
        function filterProjects() {
            const query = searchInput.value.toLowerCase();
            
            const filtered = allProjects.filter(project => {
                // Ensure project.tags is an array for safe joining
                const tags = Array.isArray(project.tags) ? project.tags : [];
                
                // FIX: Search now includes the new description fields (short_description and full_description)
                const searchString = [
                    project.title, 
                    project.short_description, 
                    project.full_description,
                    tags.join(' '),
                    project.category
                ].join(' ').toLowerCase();

                return searchString.includes(query);
            });

            renderProjects(filtered);
        }

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterProjects, 300);
        });

        // --- THEME TOGGLE LOGIC ---

        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        function updateThemeIcons(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        updateThemeIcons(isDarkMode);

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            
            localStorage.setItem('theme', newTheme);
            updateThemeIcons(newTheme === 'dark');
        });


        // Start the application
        fetchAndRenderAllProjects();
    </script>
</head>

<body class="transition-colors duration-500 font-sans">

    <header class="sticky top-0 z-40 shadow-2xl shadow-indigo-900/10 dark:shadow-indigo-900/30 bg-white/70 dark:bg-gray-900/70 backdrop-blur-lg border-b border-gray-200/50 dark:border-gray-700/50">
        <div class="max-w-7xl mx-auto p-5 flex justify-between items-center">
            
            <h1 class="text-3xl md:text-4xl font-extrabold text-primary dark:text-primary-light transition-colors">
                <span class="text-gray-900 dark:text-white">Codely</span><span class="ml-1">.Fun</span>
            </h1>

            <div class="flex items-center space-x-6">
                
                <nav class="hidden md:flex space-x-6 text-lg font-medium">
                    <a href="https://codely.fun/" target="_blank" rel="noopener noreferrer" class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition">
                        <i class="fas fa-info-circle mr-1"></i>About
                    </a>
                    <a href="https://codely.fun/" target="_blank" rel="noopener noreferrer" class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition">
                        <i class="fas fa-file-alt mr-1"></i>T&C
                    </a>
                </nav>
                
                <button id="theme-toggle" class="p-3 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i id="sun-icon" class="fas fa-sun w-6 h-6 hidden"></i>
                    <i id="moon-icon" class="fas fa-moon w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-7xl px-4 py-12 md:py-16">
        
        <div class="text-center mb-16">
            <h2 class="text-5xl md:text-7xl font-extrabold text-gray-900 dark:text-white mb-4 leading-tight">
                Explore the Open Source <span class="text-gradient">Codely.fun</span>
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-10">
                Discover innovative tools, scripts, and applications created by the community. **View code, download, and get involved!**
            </p>

            <div class="relative w-full max-w-4xl mx-auto">
                <i class="fas fa-search absolute left-5 top-1/2 transform -translate-y-1/2 text-primary-light"></i>
                <input type="text" id="search-input" placeholder="Search by project name, tech stack (React, Python), or category..."
                       class="w-full p-5 pl-14 border-4 border-gray-300 dark:border-gray-600 rounded-2xl shadow-xl hover:shadow-indigo-300/50 dark:hover:shadow-indigo-700/50 focus:ring-4 focus:ring-primary-light/50 focus:border-primary transition-all duration-300 bg-white dark:bg-gray-800 dark:text-white text-base md:text-lg"
                >
            </div>
        </div>

        <div id="projects-container">
            <div id="loading-spinner" class="text-center py-20 text-gray-500 dark:text-gray-400">
                <i class="fas fa-hammer fa-spin fa-3x text-primary mx-auto mb-4"></i>
                <p class="text-2xl font-medium">Forging the list of projects...</p>
            </div>
        </div>

        <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300 opacity-0">
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto transform transition-transform duration-300 scale-95">
                <div class="p-6 md:p-10">
                    <div class="flex justify-between items-start border-b pb-4 mb-6 dark:border-gray-700">
                        <h2 id="modal-title" class="text-3xl font-black text-gray-900 dark:text-white"></h2>
                        <button id="close-modal" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                            <i class="fas fa-times w-7 h-7"></i>
                        </button>
                    </div>

                    <div id="modal-content" class="space-y-8">
                        </div>
                </div>
            </div>
        </div>

    </main>
</body>
</html>
