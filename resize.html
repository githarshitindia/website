<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Zero Ads GOVT. Exam Photo & Signature Resizer | Compress Image to KB | Made in India 🇮🇳</title>
    <meta name="description" content="Free Online, AD-FREE GOVT Exam Photo and Signature Resizer tool. Crop and compress images to exact pixel dimensions (e.g., 50KB) for SSC, UPSC, Bank exams. 100% Secure, No data stored!">
    <meta name="keywords" content="govt exam photo resizer, compress image to 50kb, ssc photo resizer, upsc signature size, online photo cropper, ad free photo resizer, made in india">
    <meta name="author" content="Codely.fun">
    <meta name="robots" content="index, follow">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES: DARK THEME (DEFAULT) --- */
        :root {
            --bg-primary: #121212; /* Main Dark Background */
            --bg-secondary: #1E1E1E; /* Settings Panel Background */
            --bg-card: #282828; /* Card/Container Background */
            --text-primary: #E0E0E0; /* Primary Light Text */
            --text-secondary: #BBBBBB; /* Secondary Text */
            --color-primary: #90CAF9; /* Light Blue for accents/links */
            --color-primary-dark: #64B5F6;
            --color-success: #69F0AE; /* Bright Green */
            --color-error: #FF8A80; /* Light Red */
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.5), 0 1px 2px rgba(0,0,0,0.8);
            --shadow-elevated: 0 10px 30px rgba(0, 0, 0, 0.4);
            --border-color: #333333;
            --border-radius: 12px;
            --bg-privacy: #3A3A3A; /* Background for the privacy message */
            --text-privacy: #F0F0F0;
        }

        /* --- LIGHT THEME OVERRIDES --- */
        body.light-theme {
            --bg-primary: #F8F9FA; 
            --bg-secondary: #F1F3F4; 
            --bg-card: #FFFFFF;
            --text-primary: #3C4043;
            --text-secondary: #5F6368;
            --color-primary: #1A73E8;
            --color-primary-dark: #1558B5;
            --color-success: #34A853; 
            --color-error: #EA4335; 
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.12);
            --shadow-elevated: 0 10px 30px rgba(0, 0, 0, 0.1);
            --border-color: #E0E0E0;
            --bg-privacy: #E8F0FE; /* Light Blue/Gray for privacy message */
            --text-privacy: #1A73E8;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary); 
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
            scroll-behavior: smooth;
            transition: background 0.3s, color 0.3s;
        }
        
        header {
            background: var(--bg-card);
            padding: 20px 20px;
            text-align: center;
            box-shadow: var(--shadow-subtle);
        }
        header h1 {
            margin: 0;
            color: var(--color-primary);
            font-size: 2.2em;
            font-weight: 700;
        }
        
        .container {
            max-width: 1200px; 
            margin: 30px auto;
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-elevated);
            flex: 1;
            transition: background 0.3s, box-shadow 0.3s;
        }
        
        /* --- WIZARD LAYOUT --- */
        .wizard-layout {
            display: flex;
            gap: 25px;
        }

        .settings-panel {
            flex: 0 0 320px;
            padding: 20px;
            border-radius: var(--border-radius);
            background: var(--bg-secondary); 
        }

        .cropper-panel {
            flex: 1;
            padding: 20px;
            border-radius: var(--border-radius);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        /* --- CROPPER UI --- */
        #cropper-container {
            position: relative;
            max-width: 100%;
            margin: 15px auto;
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        #original-image {
            display: block;
            width: 100%;
            height: auto;
            user-select: none;
            transition: filter 0.2s ease-out;
        }
        #crop-box {
            position: absolute;
            border: 3px dashed #FFFFFF;
            outline: 2px solid var(--color-primary);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
            cursor: move;
            touch-action: none;
            box-sizing: border-box;
            transition: outline-color 0.1s;
        }
        
        /* --- CONTROL STYLES --- */
        .step { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .step h3 { margin-top: 0; color: var(--text-primary); font-size: 1.3em; margin-bottom: 15px; font-weight: 600; }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            font-size: 0.95em; 
        }
        
        select, input[type="file"], input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            box-sizing: border-box; 
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input[type="number"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(144, 202, 249, 0.3);
            outline: none;
        }

        .options-row { display: flex; gap: 15px; }
        .option-group { flex: 1; }
        
        /* Range Slider Styling (Adapted for Dark Theme) */
        input[type="range"] { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 6px; 
            background: var(--border-color); 
            border-radius: 3px; 
            margin: 5px 0 15px 0; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 16px; 
            height: 16px; 
            background: var(--color-primary); 
            cursor: pointer; 
            border-radius: 50%; 
            border: 3px solid var(--bg-card);
            box-shadow: var(--shadow-subtle);
        }
        
        /* Action Buttons */
        .action-button { 
            background: var(--color-primary); 
            color: var(--bg-primary); 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.05em; 
            font-weight: 600; 
            width: 100%; 
            margin-top: 8px; 
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--shadow-subtle);
        }
        .action-button:hover { 
            background: var(--color-primary-dark); 
            transform: translateY(-1px);
        }

        #download-btn { background: var(--color-success); color: var(--bg-primary); display: none; }
        #download-btn:hover { background: #388E3C; }
        
        #preview-canvas { 
            display: block; 
            margin: 20px auto 0; 
            border: 2px solid var(--color-primary); 
            border-radius: 8px; 
            box-shadow: var(--shadow-subtle);
        }
        
        /* --- DIMENSIONS CARD (#size-info) --- */
        #size-info {
            padding: 5px 8px; 
            border-radius: 8px; 
            margin-top: 10px; 
            background: var(--bg-card); 
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--border-color); 
            font-weight: 400; 
        }

        /* --- FILE SIZE STATUS CARD (#file-size-info) --- */
        .info { 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 10px; 
            font-size: 0.9em; 
            font-weight: 600;
            border-left: 5px solid;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Dynamic Feedback Classes */
        .info.info-warning { border-left-color: #FFC107; background: #3A331A; color: #FFC107; }
        .info.info-success { border-left-color: var(--color-success); background: #1A3A1E; color: var(--color-success); }
        .info.info-error { border-left-color: var(--color-error); background: #3A1A1A; color: var(--color-error); }
        
        /* --- COMPACTED INFO CARD VIEW --- */
        .info-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap; 
            gap: 5px;
            padding: 0;
            line-height: 1.2;
        }
        .detail-item {
            flex: 1 1 30%; 
            padding: 0; 
            text-align: center;
            border-right: 1px solid var(--border-color); 
        }
        .detail-item:last-child {
            border-right: none;
        }
        .detail-label {
            display: block;
            font-size: 0.65em; 
            color: var(--text-secondary);
            margin-bottom: 0px; 
            font-weight: 500;
            text-transform: uppercase;
        }
        .detail-value {
            display: block;
            font-size: 0.9em; 
            font-weight: 800; 
            color: var(--color-primary); 
        }

        /* --- PRIVACY MESSAGE STYLING --- */
        .privacy-message {
            max-width: 1200px; 
            margin: 20px auto 10px;
            padding: 15px 30px;
            text-align: center;
            font-size: 1.0em;
            font-weight: 500;
            color: var(--text-privacy);
            background: var(--bg-privacy);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            line-height: 1.4;
        }
        .privacy-message strong {
            font-weight: 700;
            color: var(--color-primary);
        }

        /* --- MOBILE BLOCKER OVERLAY STYLING (NEW) --- */
        #mobile-blocker {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); 
            z-index: 9999;
            color: var(--text-primary);
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            
        }
        #mobile-blocker-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-elevated);
            max-width: 80%;
        }
        #mobile-blocker h2 {
            color: var(--color-primary);
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        #mobile-blocker p {
            font-size: 1.1em;
            color: var(--text-secondary);
        }
        /* --- END MOBILE BLOCKER STYLING --- */


        /* --- RESPONSIVENESS (Mobile First) --- */
        @media (max-width: 900px) {
            .container { margin: 20px; padding: 20px; }
            .wizard-layout { flex-direction: column; }
            .settings-panel { order: 2; flex: 1; }
            .cropper-panel { order: 1; padding: 15px; }
            .options-row { flex-direction: column; gap: 0; }
            .option-group { margin-bottom: 15px; }
            
            .info-details { 
                flex-direction: column; 
                gap: 0;
            }
            .detail-item {
                border-right: none;
                border-bottom: 1px dashed var(--border-color);
                padding: 5px 0; 
            }
            .detail-item:last-child {
                border-bottom: none;
            }
            
            /* SHOW THE BLOCKER ON MOBILE */
            #mobile-blocker {
                display: flex;
            }
        }

        @media (max-width: 480px) {
            .container { margin: 10px; padding: 15px; border-radius: 10px; }
            .step { margin-bottom: 20px; }
            .privacy-message { font-size: 0.9em; padding: 10px 15px; }
        }
        
        /* Footer Styling */
        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: auto; 
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }
        
        /* Hint Section Styling */
        .hint-section h2 { color: var(--text-secondary) !important; }
        .hint-section > div { background: var(--bg-card) !important; }
        .hint-section li { color: var(--text-secondary) !important; }
    </style>
</head>
<body>
    
    <div id="mobile-blocker">
        <div id="mobile-blocker-content">
            <h2>Desktop Mode Recommended</h2>
            <p>For the best cropping and resizing experience, especially the interactive controls, please open this site in a <strong>Desktop Browser</strong> or switch your mobile browser to <strong>Desktop Site</strong> mode.</p>
            <p style="margin-top: 20px; font-weight: 600;">Interaction is disabled on smaller screens for precision reasons.</p>
        </div>
    </div>
    <header>
        <h1>GOVT. Exams Photo & Signature ReSizer</h1>
    </header>

    <div class="container">
        <div class="wizard-layout">
            
            <div class="cropper-panel">
                <h2 style="color: var(--color-primary);">Interactive Cropper & Resizer Preview</h2>
                <p id="crop-instruction" style="text-align: center; color: var(--text-secondary); padding: 20px;">Use the settings on the left to upload your image and set the required dimensions.</p>

                <div id="cropper-container">
                    <img id="original-image" alt="Upload your Photo or Signature for GOVT. Exam resizing and cropping" style="display: none;">
                    <div id="crop-box" style="display: none;"></div>
                </div>
                
                <h2 style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; color: var(--color-primary);">Final Resized Image Preview</h2>
                <canvas id="preview-canvas" style="display: none;"></canvas>
            </div>
            
            <div class="settings-panel">
                
                <div class="step">
                    <h3>1. Select Required Dimensions & Type</h3>
                    <div class="options-row">
                        <div class="option-group">
                            <label for="type">📷 Type :</label>
                            <select id="type">
                                <option value="photo">Photo</option>
                                <option value="signature">Signature</option>
                            </select>
                        </div>

                        <div class="option-group">
                            <label for="exam">🏛️ Exam Preset:</label>
                            <select id="exam">
                                <option value="custom">👉 Custom Dimensions</option>
                                </select>
                        </div>
                    </div>

                    <div id="custom-inputs" class="options-row">
                        <div class="option-group">
                            <label for="custom-width">Width (px):</label>
                            <input type="number" id="custom-width" value="300" min="10" max="2000">
                        </div>
                        <div class="option-group">
                            <label for="custom-height">Height (px):</label>
                            <input type="number" id="custom-height" value="400" min="10" max="2000">
                        </div>
                    </div>
                    <div id="size-info"></div>
                </div>

                <div class="step">
                    <h3>2. Upload Image and Adjust Filters</h3>
                    <label for="file">📤 Select Image (JPG/PNG) for Cropping:</label>
                    <input type="file" id="file" accept="image/*">
                    
                    <label for="brightness-slider">🔆 Brightness: <span id="brightness-val">100%</span></label>
                    <input type="range" id="brightness-slider" min="50" max="150" value="100">

                    <label for="contrast-slider">⚫ Contrast: <span id="contrast-val">100%</span></label>
                    <input type="range" id="contrast-slider" min="50" max="150" value="100">
                    
                    <button class="action-button" id="reset-filters-btn" style="background: #5F6368;">🔄 Reset Filters</button>
                </div>
                
                <div class="step">
                    <h3>3. Set File Size Limit & Download</h3>
                    
                    <div class="options-row">
                        <div class="option-group">
                            <label for="output-format">💾 Output Format:</label>
                            <select id="output-format">
                                <option value="png">PNG (Lossless)</option>
                                <option value="jpeg" selected>JPEG (Compressed)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="target-kb">🎯 Target Max Size (KB):</label>
                            <input type="number" id="target-kb" value="50" min="1" max="5000" placeholder="e.g., 50">
                        </div>
                    </div>
                    
                    <div class="options-row">
                        <div class="option-group" style="flex: auto;"> 
                            <label for="kb-increaser">➕ Custom KB Increase (KB):</label>
                            <input type="number" id="kb-increaser" value="0" min="0" max="1000" placeholder="e.g., 10">
                        </div>
                    </div>
                    <div id="jpeg-quality-group" style="display: none;">
                        <label for="jpeg-quality-slider">🖼️ JPEG Quality: <span id="jpeg-quality-val">90%</span></label>
                        <input type="range" id="jpeg-quality-slider" min="50" max="100" value="90">
                    </div>

                    <button class="action-button" id="crop-btn">✅ Apply Crop & Check Size (Compress)</button>
                    <div id="file-size-info" class="info" style="display: none;"></div>
                    <button class="action-button" id="download-btn">⬇️ Download Final Resized Image</button>
                    
                </div>
                
                <div class="step" style="border-bottom: none; padding-bottom: 0;">
                    <h3>4. Display Settings</h3>
                    <label for="theme-select">🎨 Theme:</label>
                    <select id="theme-select">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>

            </div>
            
        </div>
        
    </div>
    
    <div class="hint-section" style="max-width: 1200px; margin: 0 auto 30px; padding: 0 30px;">
        <h2>💡 Common GOVT. Exam Photo/Signature Requirements (SSC, UPSC, Banking, BPSC)</h2>
        <div style="padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-subtle);">
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 5px;"><strong>SSC Photo:</strong> 200×250px (20-50KB) | <strong>Signature:</strong> 140×60px (10-20KB)</li>
                <li style="margin-bottom: 5px;"><strong>IBPS/SBI Bank Photo:</strong> 200×230px (20-50KB) | <strong>Signature:</strong> 140×60px (10-20KB, Black Ink)</li>
                <li style="margin-bottom: 5px;"><strong>UPSC Photo:</strong> 350×350px (20-200KB) | <strong>Signature:</strong> 354×177px (20-100KB)</li>
                <li style="margin-bottom: 5px;"><strong>RRB (Railway) Photo:</strong> 240×320px (30-70KB) | <strong>Signature:</strong> 140×60px (30-49KB)</li>
                <li style="margin-bottom: 5px;"><strong>BPSC Photo:</strong> 300×300px (<100KB) | <strong>Signature:</strong> 300×80px (<60KB)</li>
            </ul>
        </div>
    </div>

    <div class="privacy-message">
        We care deeply about your data! This tool works entirely in your browser like an <strong>offline system</strong>. We are <strong>not using any database</strong> to store your images. Your files never leave your device.
        <br>
        <span style="font-weight: 700;">Made with love in India for Indians ❤️</span>
    </div>

    <footer>
        <p>© 2025 Codely.fun (Harshit Singh) | Free Online Image Resizer for Government Exams | **NO ADS**</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const typeSelect = document.getElementById('type');
        const examSelect = document.getElementById('exam');
        const customInputsDiv = document.getElementById('custom-inputs');
        const customWidthInput = document.getElementById('custom-width');
        const customHeightInput = document.getElementById('custom-height');
        const sizeInfo = document.getElementById('size-info');
        const fileInput = document.getElementById('file');
        const cropperContainer = document.getElementById('cropper-container');
        const originalImage = document.getElementById('original-image');
        const cropBox = document.getElementById('crop-box');
        const previewCanvas = document.getElementById('preview-canvas');
        const cropBtn = document.getElementById('crop-btn');
        const downloadBtn = document.getElementById('download-btn');
        const fileSizeInfo = document.getElementById('file-size-info');
        const cropInstruction = document.getElementById('crop-instruction');
        const brightnessSlider = document.getElementById('brightness-slider');
        const contrastSlider = document.getElementById('contrast-slider');
        const brightnessVal = document.getElementById('brightness-val');
        const contrastVal = document.getElementById('contrast-val');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const previewCtx = previewCanvas.getContext('2d');
        const themeSelect = document.getElementById('theme-select');
        
        // Output Elements
        const outputFormatSelect = document.getElementById('output-format');
        const targetKBInput = document.getElementById('target-kb');
        const kbIncreaserInput = document.getElementById('kb-increaser'); // Added DOM reference
        const jpegQualityGroup = document.getElementById('jpeg-quality-group');
        const jpegQualitySlider = document.getElementById('jpeg-quality-slider');
        const jpegQualityVal = document.getElementById('jpeg-quality-val');

        // --- State Variables ---
        let sizes = {
            ssc: { photo: { width: 200, height: 250, maxSize: '50KB' }, signature: { width: 140, height: 60, maxSize: '20KB' } },
            ibps: { photo: { width: 200, height: 230, maxSize: '50KB' }, signature: { width: 140, height: 60, maxSize: '20KB' } },
            upsc: { photo: { width: 350, height: 350, maxSize: '200KB' }, signature: { width: 354, height: 177, maxSize: '100KB' } },
            rrb: { photo: { width: 240, height: 320, maxSize: '70KB' }, signature: { width: 140, height: 60, maxSize: '49KB' } },
            bpsc: { photo: { width: 300, height: 300, maxSize: '100KB' }, signature: { width: 300, height: 80, maxSize: '60KB' } },
        };
        let imageLoaded = false;
        let cropRatio = 1;
        let cropWidthPx = 300;
        let cropHeightPx = 400;

        // --- New Global Variables for Download ---
        let currentDownloadDataURL = null; 
        let currentDownloadMimeType = null;
        // --- End New Global Variables ---

        // --- THEME LOGIC ---
        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            localStorage.setItem('theme', theme);
            themeSelect.value = theme;
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to 'dark'
            setTheme(savedTheme);
        }

        themeSelect.addEventListener('change', (e) => {
            setTheme(e.target.value);
        });
        // --- END THEME LOGIC ---


        // --- Core Functions: Dimensions & Info ---

        function getDimensions() {
            const exam = examSelect.value;
            const type = typeSelect.value;
            let w, h, maxS;

            if (exam === 'custom') {
                w = parseInt(customWidthInput.value, 10);
                h = parseInt(customHeightInput.value, 10);
                maxS = 'N/A';
            } else if (sizes[exam] && sizes[exam][type]) {
                w = sizes[exam][type].width;
                h = sizes[exam][type].height;
                maxS = sizes[exam][type].maxSize;
            } else {
                return null;
            }

            if (isNaN(w) || isNaN(h) || w <= 0 || h <= 0) return null;
            return { width: w, height: h, maxSize: maxS, ratio: w / h };
        }

        function updateSizeInfo() {
            const dims = getDimensions();
            if (!dims) {
                sizeInfo.innerHTML = '❌ <strong>ERROR:</strong> Invalid dimensions.';
                return;
            }

            cropWidthPx = dims.width;
            cropHeightPx = dims.height;
            cropRatio = dims.ratio;

            const exam = examSelect.value;
            
            let maxS_display = dims.maxSize === 'N/A' ? 'Not Set' : dims.maxSize;
            let ratio_label = exam === 'custom' ? 'RATIO' : 'ASPECT RATIO';
            
            let infoHTML = `
                <div class="info-details">
                    <div class="detail-item">
                        <span class="detail-label">Dimensions</span>
                        <span class="detail-value">${dims.width} x ${dims.height} px</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Max File Size</span>
                        <span class="detail-value">${maxS_display}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">${ratio_label}</span>
                        <span class="detail-value">${(cropRatio).toFixed(2)}:1</span>
                    </div>
                </div>
            `;
            
            sizeInfo.innerHTML = infoHTML;

            if (exam === 'custom') {
                customInputsDiv.style.display = 'flex';
                targetKBInput.value = '50';
            } else {
                customInputsDiv.style.display = 'none';
                
                const maxS = dims.maxSize;
                const presetTargetKB = parseInt(maxS, 10);
                if (!isNaN(presetTargetKB)) {
                    targetKBInput.value = presetTargetKB;
                } else {
                    targetKBInput.value = '50'; 
                }
            }

            if (imageLoaded) {
                initializeCropBox();
            }
        }

        // --- Cropper Setup & Logic ---
        function initializeCropBox() {
            const containerWidth = cropperContainer.offsetWidth;
            const containerHeight = originalImage.offsetHeight;
            if (containerHeight === 0 || containerWidth === 0) {
                 setTimeout(initializeCropBox, 100);
                 return;
            }

            const containerRatio = containerWidth / containerHeight;

            let boxWidth, boxHeight;

            if (cropRatio > containerRatio) {
                boxWidth = containerWidth;
                boxHeight = containerWidth / cropRatio;
            } else {
                boxHeight = containerHeight;
                boxWidth = containerHeight * cropRatio;
            }
            
            const maxDimension = Math.min(containerWidth, containerHeight) * 0.9;
            if (boxWidth > maxDimension) {
                boxWidth = maxDimension;
                boxHeight = boxWidth / cropRatio;
            } else if (boxHeight > maxDimension) {
                boxHeight = maxDimension;
                boxWidth = boxHeight * cropRatio;
            }
            
            const x = (containerWidth - boxWidth) / 2;
            const y = (containerHeight - boxHeight) / 2;

            cropBox.style.width = `${boxWidth}px`;
            cropBox.style.height = `${boxHeight}px`;
            cropBox.style.left = `${x}px`;
            cropBox.style.top = `${y}px`;
            cropBox.style.display = 'block';

            cropperContainer.style.height = `${containerHeight}px`;

            updatePreview();
        }

        function updatePreview() {
            if (!imageLoaded) return;

            const imageRect = originalImage.getBoundingClientRect();
            
            const scaleX = originalImage.naturalWidth / imageRect.width;
            const scaleY = originalImage.naturalHeight / imageRect.height;
            
            const cropOffsetLeft = cropBox.offsetLeft;
            const cropOffsetTop = cropBox.offsetTop;

            const cropX = (cropOffsetLeft) * scaleX;
            const cropY = (cropOffsetTop) * scaleY;
            const cropW = cropBox.offsetWidth * scaleX;
            const cropH = cropBox.offsetHeight * scaleY;

            previewCanvas.width = cropWidthPx;
            previewCanvas.height = cropHeightPx;
            previewCanvas.style.display = 'block';

            previewCtx.clearRect(0, 0, cropWidthPx, cropHeightPx);
            
            // Apply current CSS filters to the canvas image
            previewCtx.filter = originalImage.style.filter || 'none';

            previewCtx.drawImage(
                originalImage,
                cropX, cropY, cropW, cropH,
                0, 0, cropWidthPx, cropHeightPx
            );

            // Clear the filter on the canvas context for future drawings
            previewCtx.filter = 'none';
        }
        
        // --- Cropper Dragging Logic ---
        let isDragging = false;
        let startX, startY;
        let initialCropLeft, initialCropTop;

        function startDrag(e) {
            e.preventDefault();
            if (!imageLoaded) return;
            isDragging = true;
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            initialCropLeft = cropBox.offsetLeft;
            initialCropTop = cropBox.offsetTop;
            cropBox.style.cursor = 'grabbing';
        }

        function moveDrag(e) {
            if (!isDragging) return;
            const currentX = e.clientX || e.touches[0].clientX;
            const currentY = e.clientY || e.touches[0].clientY;
            const dx = currentX - startX;
            const dy = currentY - startY;
            let newLeft = initialCropLeft + dx;
            let newTop = initialCropTop + dy;
            const containerWidth = cropperContainer.offsetWidth;
            const containerHeight = cropperContainer.offsetHeight;
            const boxWidth = cropBox.offsetWidth;
            const boxHeight = cropBox.offsetHeight;
            
            newLeft = Math.max(0, Math.min(newLeft, containerWidth - boxWidth));
            newTop = Math.max(0, Math.min(newTop, containerHeight - boxHeight));
            
            cropBox.style.left = `${newLeft}px`;
            cropBox.style.top = `${newTop}px`;
            updatePreview();
        }

        function endDrag() {
            isDragging = false;
            cropBox.style.cursor = 'move';
            updatePreview();
        }
        
        cropBox.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('mouseup', endDrag);
        cropBox.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', moveDrag, { passive: false });
        document.addEventListener('touchend', endDrag);


        // --- Filter Functions (CSS-based) ---
        function applyFilters() {
            const brightness = brightnessSlider.value;
            const contrast = contrastSlider.value;
            brightnessVal.textContent = `${brightness}%`;
            contrastVal.textContent = `${contrast}%`;
            originalImage.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
            if (imageLoaded) { updatePreview(); }
        }
        
        function resetFilters() {
            brightnessSlider.value = 100;
            contrastSlider.value = 100;
            applyFilters();
        }

        // --- Output Format Controls ---
        outputFormatSelect.addEventListener('change', () => {
            if (outputFormatSelect.value === 'jpeg') {
                jpegQualityGroup.style.display = 'block';
            } else {
                jpegQualityGroup.style.display = 'none';
            }
        });
        
        jpegQualitySlider.addEventListener('input', () => {
            jpegQualityVal.textContent = `${jpegQualitySlider.value}%`;
        });


        // --- Helper function for byte padding (for download) ---
        function dataURLtoPaddedBlob(dataurl, mimeType, paddingKB) {
            const paddingBytes = paddingKB * 1024;
            
            // 1. Convert Base64 data to Uint8Array
            const base64Data = dataurl.split(',')[1];
            const bstr = atob(base64Data);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            const baseBlob = new Blob([u8arr], {type: mimeType});
            
            if (paddingBytes > 0) {
                // 2. Create padding bytes (using ASCII space character 32, which is safe)
                const paddingArray = new Uint8Array(paddingBytes).fill(32); 
                
                // 3. Combine the base image Blob and the padding data
                return new Blob([baseBlob, paddingArray.buffer], {type: mimeType});
            }

            return baseBlob; // Return original blob if no padding needed
        }
        // --- End Helper Function ---

        // --- Event Handlers & Initialization ---

        // Handle File Upload
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (!file || !file.type.startsWith('image/')) {
                imageLoaded = false;
                cropperContainer.style.display = 'none';
                cropInstruction.style.display = 'block';
                downloadBtn.style.display = 'none';
                fileSizeInfo.style.display = 'none';
                return;
            }
            
            originalImage.onload = () => {
                imageLoaded = true;
                cropperContainer.style.display = 'block';
                originalImage.style.display = 'block';
                cropInstruction.style.display = 'none';
                resetFilters(); 
                setTimeout(initializeCropBox, 100); 
            };
            originalImage.src = URL.createObjectURL(file);
        });
        
        // Filter and Dimension Change Listeners
        typeSelect.addEventListener('change', updateSizeInfo); 
        examSelect.addEventListener('change', updateSizeInfo); 
        customWidthInput.addEventListener('input', updateSizeInfo);
        customHeightInput.addEventListener('input', updateSizeInfo);
        brightnessSlider.addEventListener('input', applyFilters);
        contrastSlider.addEventListener('input', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);

        // --- Handle Crop Button Click (Check Size) ---
        cropBtn.addEventListener('click', () => {
            if (!imageLoaded) {
                alert("Please upload an image first.");
                fileSizeInfo.innerHTML = `⚠️ <strong>Error:</strong> Please upload an image in Step 2.`;
                fileSizeInfo.className = 'info info-error';
                fileSizeInfo.style.display = 'block';
                return;
            }
            
            updatePreview(); 
            
            const format = outputFormatSelect.value;
            let dataURL;
            let mimeType;
            let quality;
            
            if (format === 'jpeg') {
                quality = parseInt(jpegQualitySlider.value) / 100;
                mimeType = 'image/jpeg';
                dataURL = previewCanvas.toDataURL(mimeType, quality);
            } else {
                mimeType = 'image/png';
                dataURL = previewCanvas.toDataURL(mimeType);
            }
            
            // Store the data for the download button to use later
            currentDownloadDataURL = dataURL;
            currentDownloadMimeType = mimeType;
            
            const dataPrefix = `data:${mimeType};base64,`;
            
            if (!dataURL.startsWith(dataPrefix)) {
                fileSizeInfo.innerHTML = `❌ <strong>Error:</strong> Failed to generate image data. Try another file.`;
                fileSizeInfo.className = 'info info-error';
                fileSizeInfo.style.display = 'none';
                downloadBtn.style.display = 'none';
                return;
            }
            
            const base64Data = dataURL.substring(dataPrefix.length);
            const fileSizeBytes = Math.ceil(base64Data.length * 0.75); 
            
            const fileSizeKB = Math.round(fileSizeBytes / 1024);
            
            const targetKB = parseInt(targetKBInput.value, 10);
            const customIncreaseKB = parseInt(kbIncreaserInput.value, 10) || 0; 
            
            // Calculate the size after adding the custom increase (for check/display)
            const adjustedFileSizeKB = fileSizeKB + customIncreaseKB; 
            
            const adjustedSizeText = adjustedFileSizeKB < 1024 
                ? `${adjustedFileSizeKB} KB` 
                : `${(adjustedFileSizeKB / 1024).toFixed(2)} MB`; 
            
            
            const isUnderLimit = adjustedFileSizeKB <= targetKB; 
            const status = isUnderLimit ? '✅ <strong>UNDER LIMIT</strong>' : '❌ <strong>OVER LIMIT</strong>';
            const statusClass = isUnderLimit ? 'info info-success' : 'info info-error';
            
            
            // SIMPLIFIED OUTPUT
            let infoHTML = `
                🎯 Target Max Size: <strong>${targetKB} KB</strong><br>
                ⬇️ Final Download Size: <strong>${adjustedSizeText}</strong> 
                ${customIncreaseKB > 0 ? `(Includes ${customIncreaseKB} KB padding)` : ''}<br>
                Status: ${status}
            `;

            fileSizeInfo.innerHTML = infoHTML;
            fileSizeInfo.className = statusClass;
            fileSizeInfo.style.display = 'block';
            downloadBtn.style.display = 'block';
        });

        // Handle Download Button Click (Uses Padding)
        downloadBtn.addEventListener('click', () => {
            if (!currentDownloadDataURL) return;

            const format = outputFormatSelect.value;
            let extension = format === 'jpeg' ? 'jpg' : 'png';
            const customIncreaseKB = parseInt(kbIncreaserInput.value, 10) || 0;

            // 1. Get the Blob with padding bytes added to the end
            const finalBlob = dataURLtoPaddedBlob(currentDownloadDataURL, currentDownloadMimeType, customIncreaseKB);
            
            // 2. Create a temporary URL for the Blob and trigger download
            const link = document.createElement('a');
            const blobUrl = URL.createObjectURL(finalBlob);
            
            link.download = `${typeSelect.value}_${examSelect.value}_padded.${extension}`;
            link.href = blobUrl;
            link.click();
            
            // Clean up the object URL after download is initiated
            URL.revokeObjectURL(blobUrl);
        });

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); // Load saved theme first
            populateExamOptions();
            updateSizeInfo(); 
            applyFilters();
            outputFormatSelect.dispatchEvent(new Event('change'));
        });

        function populateExamOptions() {
             const customOption = examSelect.querySelector('option[value="custom"]');
            examSelect.innerHTML = ''; 
            for (const exam in sizes) {
                const option = document.createElement('option');
                option.value = exam;
                option.textContent = exam.toUpperCase(); 
                examSelect.appendChild(option);
            }
            examSelect.appendChild(customOption);
            examSelect.value = 'ssc';
        }

    </script>
</body>
</html>
