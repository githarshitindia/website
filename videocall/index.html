<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Watch Party with Video Call</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .room-info {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 0;
            height: calc(100vh - 160px);
        }

        .video-call-section {
            background: #1a1a2e;
            padding: 20px;
            overflow-y: auto;
        }

        .video-call-header {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .call-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .call-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .call-btn.active {
            background: #4CAF50;
            color: white;
        }

        .call-btn.inactive {
            background: #f44336;
            color: white;
        }

        .call-btn:hover {
            opacity: 0.8;
        }

        .video-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .admin-tag {
            background-color: #f44336;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 10px;
        }

        .video-section {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-controls {
            display: flex;
            gap: 10px;
        }

        #videoUrlInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border 0.3s;
        }

        #videoUrlInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #loadVideoBtn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        #loadVideoBtn:hover {
            transform: translateY(-2px);
        }

        /* Video.js player container */
        .video-js {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }
        
        #player {
            width: 100%;
            height: 100%;
        }

        .chat-section {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header h2 {
            font-size: 20px;
            color: #333;
        }

        .users-online {
            display: flex;
            flex-direction: column; 
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .user-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .user-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-grow: 1;
        }
        
        .admin-action-btn {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .admin-action-btn:hover {
            background: #45a049;
        }


        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-text {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 14px;
            word-wrap: break-word;
        }

        .message-system {
            text-align: center;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #sendBtn {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        #sendBtn:hover {
            background: #5568d3;
        }

        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .modal-content button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .modal-content button:hover {
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }

            .video-call-section {
                max-height: 300px;
            }

            .video-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .chat-section {
                border-left: none;
                border-top: 1px solid #e0e0e0;
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <h2>Join Watch Party v1.4🎉</h2>
            <input type="text" id="usernameInput" placeholder="Enter your name">
            <input type="text" id="roomIdInput" placeholder="Enter room ID (or leave blank to create)">
            <button id="joinBtn">Join Room</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="container">
            <div class="header">
                <h1>🎬 YouTube Watch Party</h1>
                <div class="room-info">Room: <span id="roomIdDisplay"></span></div>
            </div>
            
            <div class="main-content">
                <div class="video-call-section">
                    <div class="video-call-header">📹 Video Call</div>
                    <div class="call-controls">
                        <button id="toggleVideoBtn" class="call-btn inactive">📷 Video Off</button>
                        <button id="toggleAudioBtn" class="call-btn inactive">🎤 Muted</button>
                    </div>
                    <div class="video-grid" id="videoGrid">
                        <div class="video-container">
                            <video id="localVideo" autoplay muted playsinline></video>
                            <div class="video-label" id="localVideoLabel">You</div>
                        </div>
                    </div>
                </div>

                <div class="video-section">
                    <div class="video-controls" id="videoControls">
                        <input type="text" id="videoUrlInput" placeholder="Paste YouTube URL here...">
                        <button id="loadVideoBtn">Load Video</button>
                    </div>
                    <video id="player" class="video-js vjs-default-skin" controls preload="auto" data-setup='{}'></video>
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <h2>Chat</h2>
                        <div class="users-online" id="usersOnline"></div>
                    </div>
                    <div id="messages"></div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message...">
                        <button id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-youtube@3.0.1/dist/Youtube.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCXGPCCu9wLefW-Bn3kQ63rz9niHaVUogE",
            authDomain: "watch-party-f4623.firebaseapp.com",
            databaseURL: "https://watch-party-f4623-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "watch-party-f4623",
            storageBucket: "watch-party-f4623.firebasestorage.app",
            messagingSenderId: "432928189519",
            appId: "1:432928189519:web:0b4153ed3b236f7004ce3a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let player;
        let roomId;
        let username;
        let userId;
        let isUpdating = false; 
        let isAdmin = false; 
        let currentAdminId = null; 

        // Map standard YouTube API states to constants for DB synchronization
        const PLAYER_STATE = {
            UNSTARTED: -1,
            ENDED: 0,
            PLAYING: 1,
            PAUSED: 2,
            BUFFERING: 3,
            CUED: 5 
        };

        // WebRTC Variables
        let localStream = null;
        let peerConnections = {};
        let videoEnabled = false;
        let audioEnabled = false;

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // NEW: Video.js Player Initialization
        function initializeVideoPlayer() {
            player = videojs('player', {
                controls: true,
                autoplay: false,
                techOrder: ['youtube', 'html5'], // Use youtube tech first
                sources: [] 
            }, function() {
                console.log('Video.js player is ready');
                setupVideoListeners(this);
                syncWithRoom();
            });
        }
        
        // NEW: Setup Video.js Listeners
        function setupVideoListeners(playerInstance) {
            // Listeners for outgoing state changes (Admin role)
            
            // Play/Pause/End events only trigger database write if it was a user action (i.e., not isUpdating)
            playerInstance.on('play', function() { handlePlayerStateChange(PLAYER_STATE.PLAYING); });
            playerInstance.on('pause', function() { handlePlayerStateChange(PLAYER_STATE.PAUSED); });
            playerInstance.on('ended', function() { handlePlayerStateChange(PLAYER_STATE.ENDED); });
            
            // Time synchronization (to reduce database writes, only sync every 5 seconds while playing)
            playerInstance.on('timeupdate', function() {
                // Check if playing and time is roughly a multiple of 5 seconds (5, 10, 15...)
                if (!playerInstance.paused() && isAdmin && !isUpdating) {
                    const currentTime = playerInstance.currentTime();
                    if (Math.floor(currentTime * 10) % 50 === 0) { // Check every 5 seconds
                        handlePlayerStateChange(PLAYER_STATE.PLAYING);
                    }
                }
            });
        }

        // NEW: Handles outgoing state changes to Firebase (only for Admin)
        function handlePlayerStateChange(state) {
            if (isUpdating || !isAdmin) return;

            // Get videoId from the current source URL
            const videoId = getVideoIdFromUrl(player.currentSrc());

            const videoData = {
                state: state,
                time: player.currentTime(),
                videoId: videoId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Only write if the state is a significant event and a video is loaded
            if (videoId && (state === PLAYER_STATE.PLAYING || state === PLAYER_STATE.PAUSED || state === PLAYER_STATE.ENDED)) {
                db.ref(`rooms/${roomId}/video`).set(videoData);
            }
        }


        function getVideoIdFromUrl(url) {
            // Extracts ID from YouTube URL formats
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function setAdmin(newAdminId) {
            if (newAdminId === currentAdminId) return;

            await db.ref(`rooms/${roomId}/adminId`).set(newAdminId);
            
            const newAdminName = (await db.ref(`rooms/${roomId}/users/${newAdminId}/name`).once('value')).val();
            sendSystemMessage(`${newAdminName} is now the Admin.`);
        }

        // WebRTC functions (omitted for brevity)
        async function initializeMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                localStream.getVideoTracks()[0].enabled = videoEnabled;
                localStream.getAudioTracks()[0].enabled = audioEnabled;

                document.getElementById('localVideo').srcObject = localStream;

                await db.ref(`rooms/${roomId}/peers/${userId}`).set({
                    name: username,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                });
                
                await db.ref(`rooms/${roomId}/users/${userId}`).set({
                    name: username,
                    joined: firebase.database.ServerValue.TIMESTAMP
                });

                db.ref(`rooms/${roomId}/peers/${userId}`).onDisconnect().remove();
                db.ref(`rooms/${roomId}/users/${userId}`).onDisconnect().remove();

                setTimeout(() => setupPeerListeners(), 1000);

            } catch (error) {
                console.error('❌ Error accessing media:', error);
                alert('Camera/microphone access denied. Video call will not work.');
            }
        }

        function setupPeerListeners() {
            
            db.ref(`rooms/${roomId}/adminId`).on('value', (snapshot) => {
                currentAdminId = snapshot.val();
                updateAdminStatus();
            });

            db.ref(`rooms/${roomId}/peers`).on('child_added', (snapshot) => {
                const peerId = snapshot.key;
                const peerData = snapshot.val();
                
                if (peerId !== userId && !peerConnections[peerId]) {
                    addRemoteVideo(peerId, new MediaStream(), peerData.name);
                    setTimeout(() => createPeerConnection(peerId, true), 500);
                }
            });

            db.ref(`rooms/${roomId}/peers`).on('child_removed', (snapshot) => {
                const peerId = snapshot.key;
                removePeerConnection(peerId);
            });

            db.ref(`rooms/${roomId}/signals/${userId}`).on('child_added', async (snapshot) => {
                const data = snapshot.val();
                const peerId = data.from;

                try {
                    if (data.type === 'offer') {
                        if (!peerConnections[peerId]) {
                            await createPeerConnection(peerId, false);
                            const peerData = (await db.ref(`rooms/${roomId}/peers/${peerId}`).once('value')).val();
                            addRemoteVideo(peerId, new MediaStream(), peerData.name);
                        }
                        await peerConnections[peerId].setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await peerConnections[peerId].createAnswer();
                        await peerConnections[peerId].setLocalDescription(answer);
                        
                        await db.ref(`rooms/${roomId}/signals/${peerId}`).push({
                            from: userId,
                            type: 'answer',
                            answer: answer
                        });
                    } else if (data.type === 'answer') {
                        if (peerConnections[peerId]) {
                            await peerConnections[peerId].setRemoteDescription(new RTCSessionDescription(data.answer));
                        }
                    } else if (data.type === 'ice') {
                        if (peerConnections[peerId]) {
                            await peerConnections[peerId].addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    }
                    snapshot.ref.remove();
                } catch (error) {
                    console.error('❌ Signal error:', error);
                }
            });
        }

        async function createPeerConnection(peerId, createOffer) {
            
            const pc = new RTCPeerConnection(configuration);
            peerConnections[peerId] = pc;

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            let remoteStream = new MediaStream();
            
            pc.ontrack = (event) => {
                remoteStream.addTrack(event.track);
                
                const container = document.getElementById(`video-${peerId}`);
                let peerName = null;
                if (container) {
                    peerName = container.querySelector('.video-label').textContent;
                }
                
                addRemoteVideo(peerId, remoteStream, peerName); 
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`rooms/${roomId}/signals/${peerId}`).push({
                        from: userId,
                        type: 'ice',
                        candidate: event.candidate.toJSON()
                    });
                }
            };
            
            if (createOffer) {
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    await db.ref(`rooms/${roomId}/signals/${peerId}`).push({
                        from: userId,
                        type: 'offer',
                        offer: offer
                    });
                } catch (error) {
                    console.error('❌ Offer error:', error);
                }
            }

            return pc;
        }

        function updateAdminStatus() {
            isAdmin = (userId === currentAdminId);

            const localLabel = document.getElementById('localVideoLabel');
            localLabel.innerHTML = 'You';
            if (isAdmin) {
                localLabel.innerHTML += '<span class="admin-tag">ADMIN</span>';
            }
            
            db.ref(`rooms/${roomId}/users`).once('value', (snapshot) => {
                updateUsersList(snapshot.val() || {});
            });

            const videoControls = document.getElementById('videoControls');
            if (isAdmin) {
                videoControls.style.display = 'flex';
            } else {
                videoControls.style.display = 'none';
            }
        }
        
        function addRemoteVideo(peerId, stream, peerName) {
            let container = document.getElementById(`video-${peerId}`);
            
            if (!container) {
                container = document.createElement('div');
                container.id = `video-${peerId}`;
                container.className = 'video-container';
                
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsinline = true;
                video.srcObject = stream; 

                const label = document.createElement('div');
                label.className = 'video-label';
                label.textContent = peerName || 'Peer ' + peerId.substring(0, 6);
                
                container.appendChild(video);
                container.appendChild(label);
                document.getElementById('videoGrid').appendChild(container);
            } else {
                const video = container.querySelector('video');
                if (video.srcObject !== stream) {
                    video.srcObject = stream;
                }
            }
        }

        function removePeerConnection(peerId) {
            if (peerConnections[peerId]) {
                peerConnections[peerId].close();
                delete peerConnections[peerId];
            }
            
            const elem = document.getElementById(`video-${peerId}`);
            if (elem) elem.remove();
        }

        function toggleVideo() {
            if (localStream) {
                videoEnabled = !videoEnabled;
                localStream.getVideoTracks()[0].enabled = videoEnabled;
                
                const btn = document.getElementById('toggleVideoBtn');
                btn.textContent = videoEnabled ? '📷 Video On' : '📷 Video Off';
                btn.className = videoEnabled ? 'call-btn active' : 'call-btn inactive';
            }
        }

        function toggleAudio() {
            if (localStream) {
                audioEnabled = !audioEnabled;
                localStream.getAudioTracks()[0].enabled = audioEnabled;
                
                const btn = document.getElementById('toggleAudioBtn');
                btn.textContent = audioEnabled ? '🎤 Unmuted' : '🎤 Muted';
                btn.className = audioEnabled ? 'call-btn active' : 'call-btn inactive';
            }
        }

        function joinRoom() {
            db.ref(`rooms/${roomId}/adminId`).once('value', (snapshot) => {
                if (!snapshot.exists() && isAdmin) {
                    setAdmin(userId);
                } else if (snapshot.exists()) {
                    currentAdminId = snapshot.val();
                    isAdmin = (userId === currentAdminId);
                }
                updateAdminStatus();
            });


            db.ref(`rooms/${roomId}/users`).on('value', (snapshot) => {
                updateUsersList(snapshot.val() || {});
            });

            // Video player synchronization
            db.ref(`rooms/${roomId}/video`).on('value', (snapshot) => {
                const videoData = snapshot.val();
                if (videoData) updateVideo(videoData);
            });

            db.ref(`rooms/${roomId}/messages`).on('value', (snapshot) => {
                displayMessages(snapshot.val() || {});
            });

            sendSystemMessage(`${username} joined the room`);
            initializeMedia();
            
            // NEW: Initialize the Video.js player after joining
            initializeVideoPlayer();
        }

        function updateUsersList(users) {
            const container = document.getElementById('usersOnline');
            container.innerHTML = '';
            
            Object.entries(users).filter(([key, user]) => user.name).forEach(([userKey, user]) => {
                const entry = document.createElement('div');
                entry.className = 'user-entry';
                
                const badge = document.createElement('div');
                badge.className = 'user-badge';
                badge.textContent = user.name;
                
                if (userKey === currentAdminId) {
                    badge.innerHTML += '<span class="admin-tag">ADMIN</span>';
                }
                
                entry.appendChild(badge);
                
                if (isAdmin && userKey !== userId) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'admin-action-btn';
                    adminBtn.textContent = 'Make Admin';
                    adminBtn.onclick = () => setAdmin(userKey);
                    entry.appendChild(adminBtn);
                }
                
                container.appendChild(entry);
            });
        }

        /**
         * The core synchronization function. Rewritten for Video.js.
         */
        function updateVideo(videoData) {
            if (!player || player.isDisposed()) return;

            // CRITICAL: Immediately block local events from interfering with remote command
            isUpdating = true; 

            try {
                const currentVideoId = getVideoIdFromUrl(player.currentSrc());
                const targetVideoId = videoData.videoId;

                // 1. Load video if ID is new or player is uninitialized
                if (targetVideoId && targetVideoId !== currentVideoId) {
                    
                    const newSource = {
                        type: 'video/youtube',
                        src: `https://www.youtube.com/watch?v=${targetVideoId}`
                    };
                    
                    // Set the new video source. Video.js will handle the load.
                    player.src(newSource);
                    
                    // After loading the source, we fall through to step 2 to set the time/state.
                } 
                
                // 2. Sync State and Time
                
                // Time Sync: Seek only if difference is significant and player is ready
                if (player.readyState() >= 1) { // readyState >= 1 means metadata loaded
                    const playerTime = player.currentTime() || 0;
                    const timeDiff = Math.abs(playerTime - videoData.time);

                    if (timeDiff > 2) { 
                        player.currentTime(videoData.time);
                    }
                }

                // State Sync: Apply play/pause command explicitly
                if (videoData.state === PLAYER_STATE.PLAYING && player.paused()) {
                    // This command is critical for remote play.
                    player.play().catch(e => {
                        console.warn("Autoplay was blocked by browser. User must click play.", e);
                        // This warning is normal for browsers with strict autoplay policies.
                    });
                } else if (videoData.state === PLAYER_STATE.PAUSED && !player.paused()) {
                    player.pause();
                }
                
            } catch (error) {
                console.error('Video.js Update error:', error);
            }

            // CRITICAL: Clear the flag after a short delay to allow the player to settle/process its own events
            setTimeout(() => { isUpdating = false; }, 500);
        }

        function syncWithRoom() {
            db.ref(`rooms/${roomId}/video`).once('value', (snapshot) => {
                const videoData = snapshot.val();
                if (videoData) updateVideo(videoData);
            });
        }


        function extractVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                db.ref(`rooms/${roomId}/messages`).push({
                    user: username,
                    userId: userId,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            }
        }

        function sendSystemMessage(text) {
            db.ref(`rooms/${roomId}/messages`).push({
                system: true,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            Object.values(messages).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)).forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                
                if (msg.system) {
                    msgDiv.innerHTML = `<div class="message-system">${msg.text}</div>`;
                } else {
                    msgDiv.innerHTML = `
                        <div class="message-user">${msg.user}</div>
                        <div class="message-text">${msg.text}</div>
                    `;
                }
                
                container.appendChild(msgDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('joinBtn').addEventListener('click', () => {
                username = document.getElementById('usernameInput').value.trim();
                let inputRoomId = document.getElementById('roomIdInput').value.trim();

                if (!username) {
                    alert('Please enter your name');
                    return;
                }
                
                if (!inputRoomId) {
                    roomId = generateRoomId();
                    isAdmin = true;
                } else {
                    roomId = inputRoomId;
                }

                userId = Date.now().toString();

                document.getElementById('setupModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('roomIdDisplay').textContent = roomId;
                
                joinRoom();
            });

            // The load button now only writes the desired state (PLAYING) to Firebase
            document.getElementById('loadVideoBtn').addEventListener('click', () => {
                if (!isAdmin) {
                    alert('Only the room admin can load videos.');
                    return;
                }
                
                const url = document.getElementById('videoUrlInput').value;
                const videoId = extractVideoId(url);
                
                if (videoId) {
                    // Write the new video information and initial state (PLAYING) directly to Firebase
                    db.ref(`rooms/${roomId}/video`).set({
                        state: PLAYER_STATE.PLAYING,
                        time: 0, 
                        videoId: videoId,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    sendSystemMessage(`${username} loaded a new video`);
                    
                    document.getElementById('videoUrlInput').value = '';
                } else {
                    alert('Invalid YouTube URL');
                }
            });

            document.getElementById('toggleVideoBtn').addEventListener('click', toggleVideo);
            document.getElementById('toggleAudioBtn').addEventListener('click', toggleAudio);

            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('videoControls').style.display = 'none';
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            setupEventListeners();
        }
    </script>
</body>
</html>
